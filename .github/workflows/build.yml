# This is a basic workflow to help you get started with Actions

name: Build SBP execs

# Controls when the workflow will run
on:
  # Triggers the workflow on push or pull request events but only for the "main" branch
#  push:
#    branches:
#      - 'main'
#  pull_request:
#    branches:
#      - 'main'
  # Triggers the workflow every hour
#  schedule:
#    - cron: '0 * * * *'
  # Keep manual trigger and push events
  workflow_dispatch:

env:
  forbuildVariables: use Installer\buildVariables.cmd file
  workspace: sandboxie-plus/Sandboxie

# A workflow run is made up of one or more jobs that can run sequentially or in parallel
jobs:
  check-version:
    runs-on: ubuntu-latest
    outputs:
      new_version_available: ${{ steps.check_version.outputs.new_version_available }}
      latest_tag: ${{ steps.check_version.outputs.latest_tag }}

    steps:
    - name: Check latest release
      id: check_version
      run: |
        # Get the latest release tag from SBP repository
        latest_tag=$(curl -s https://api.github.com/repos/sandboxie-plus/Sandboxie/releases/latest | jq -r '.tag_name')
        echo "Latest SBP version: $latest_tag"
        echo "latest_tag=${latest_tag}" >> $GITHUB_OUTPUT
        
        # Get the latest release in current repository
        current_tag=$(curl -s https://api.github.com/repos/${{ github.repository }}/releases/latest | jq -r '.tag_name')
        echo "Current built version: $current_tag"
        echo "current_tag=${current_tag}" >> $GITHUB_OUTPUT
        
        if [ "$latest_tag" != "$current_tag" ]; then
          echo "new_version_available=true" >> $GITHUB_OUTPUT
          echo "New version detected! Will trigger build job."
        else
          echo "new_version_available=false" >> $GITHUB_OUTPUT
          echo "No new version available. Skipping build."
        fi

  build:
    needs: check-version
    if: needs.check-version.outputs.new_version_available == 'true'
    runs-on: windows-2022

    # Steps represent a sequence of tasks that will be executed as part of the job
    steps:

    # Checks-out your repository under $GITHUB_WORKSPACE, so your job can access it
    - name: Checkout repository
      uses: actions/checkout@v5
      with:
        repository: sandboxie-plus/Sandboxie
        ref: ${{ needs.check-version.outputs.latest_tag }}
    
    # Edit code
    # (Get-Content -Path "./SandboxiePlus/SandMan/Windows/SupportDialog.cpp") -replace 'int Days = InstallDate.daysTo(CurretnDate);', 'int Days = 1;' | Set-Content -Path "./SandboxiePlus/SandMan/Windows/SupportDialog.cpp"
    - name: Edit code
      run: |
        (Get-Content -Path "./Sandboxie/core/drv/verify.c") -replace 'NTSTATUS status;', 'NTSTATUS status=STATUS_SUCCESS;' | Set-Content -Path "./Sandboxie/core/drv/verify.c"
        (Get-Content -Path "./Sandboxie/core/drv/verify.c" -Raw) -replace 'PVOID hash = NULL;\r?\n    ULONG hashSize;', "PVOID hash = NULL;`n    ULONG hashSize;`n    goto CleanupExit;" | Set-Content -Path "./Sandboxie/core/drv/verify.c"
        (Get-Content -Path "./Sandboxie/core/drv/verify.c" -Raw) -replace 'PUNICODE_STRING signatureFileName = NULL;\r?\n    ULONG signatureSize = 0;\r?\n    PUCHAR signature = NULL;', "PUNICODE_STRING signatureFileName = NULL;`n    ULONG signatureSize = 0;`n    PUCHAR signature = NULL;`n    goto CleanupExit;" | Set-Content -Path "./Sandboxie/core/drv/verify.c"
        (Get-Content -Path "./Sandboxie/core/drv/verify.c") -replace 'Verify_CertInfo.State = 0; // clear', "Verify_CertInfo.State = 0;`n    Verify_CertInfo.active = 1;`n    Verify_CertInfo.type = eCertEternal;`n    Verify_CertInfo.level = eCertMaxLevel;`n    expiration_date.QuadPart = -1;`n    Verify_CertInfo.opt_desk = 1;`n    goto CleanupExit;" | Set-Content -Path "./Sandboxie/core/drv/verify.c"
      shell: powershell

    - name: Load Variables from buildVariables.cmd
      shell: cmd
      run: |
        @echo on
        call "${{ github.workspace }}\Installer\buildVariables.cmd" build_qt6
        echo qt6_version=%qt6_version% >> %GITHUB_ENV%
        echo qt_version=%qt6_version% >> %GITHUB_ENV%

    - name: Setup msbuild
      uses: microsoft/setup-msbuild@v2

    # Compile Sandboxie Core
    - name: Build Sandboxie x86 (DLLs & svc)
      run: msbuild /t:build Sandboxie\SandboxDll.sln /p:Configuration="SbieRelease" /p:Platform=Win32 -maxcpucount:8

    - name: Build Sandboxie x64 (all)
      run: msbuild /t:build Sandboxie\Sandbox.sln /p:Configuration="SbieRelease" /p:Platform=x64 -maxcpucount:8
      
    - name: Build Sandboxie x64 (drv)
      run: msbuild /t:build Sandboxie\SandboxDrv.sln /p:Configuration="SbieRelease" /p:Platform=x64 -maxcpucount:8

    # Prepare Qt Framework
    - name: Install Qt6 x64
      run: SandboxiePlus\install_qt.cmd x64

    - name: Installing Jom
    #  if: steps.cache-qt.outputs.cache-hit != 'true'
      run: SandboxiePlus\install_jom.cmd

    # Compile Sandboxie Plus
    - name: Build Sandboxie-Plus x64
      run: SandboxiePlus\qmake_plus.cmd x64 build_qt6

    - name: Build SbieShell x64
      run: msbuild /t:restore,build -p:RestorePackagesConfig=true SandboxiePlus\SbieShell\SbieShell.sln /p:Configuration="Release" /p:Platform=x64

    # Compile Sandboxie Tools
    - name: Build Sandboxie-Tools x64
      run: msbuild /t:build SandboxieTools\SandboxieTools.sln /p:Configuration="Release" /p:Platform=x64 -maxcpucount:8

    # Merge everything together
    - name: Add missing languages for Qt6 (issue 1528)
      run: Installer\fix_qt5_languages.cmd x64 build_qt6

    - name: Get openssl binaries
      run: Installer\get_openssl.cmd

    - name: Get 7z binaries
      run: Installer\get_7zip.cmd

    - name: Merging Build
      run: Installer\copy_build.cmd x64 build_qt6

    - name: Collect installer assets
      run: Installer\get_assets.cmd

    - name: Upload Sandboxie x64
      #if: github.ref == 'refs/heads/master' && github.event_name != 'pull_request'
      uses: actions/upload-artifact@v5.0.0
      with:
        name: SBP
        path: |
          Installer/SbiePlus_x64/*
        retention-days: 60

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ needs.check-version.outputs.latest_tag }}
        body: "SBP ${{ needs.check-version.outputs.latest_tag }} SandMan"
        files: "Installer/SbiePlus_x64/SandMan.exe"

